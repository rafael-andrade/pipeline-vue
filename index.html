<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<body>
	<div id="pipeline">

		<!-- INPUT PRA VALORES-->
		<input v-model="inteiro" placeholder="Ciclos Op. Inteiro">
		<input v-model="mult" placeholder="Mult. Float">
		<input v-model="div" placeholder="Div. Float">
		<input v-model="add" placeholder="Add/Sub Float">

		<select v-model="selected">
			<option v-for="type in types"> {{type}} </option>			
		</select>
		<div v-if="selected == 'INTEGER'">
			<select v-model="op">
				<option v-for="operation in operationsInt"> {{operation}}</option>
			</select>
			<select v-model.number="rt">
				<option v-for="register in r" v-bind:value="register.id" > {{register.name}}</option>
			</select>
			<select v-model.number="rs">
				<option v-for="register in r" v-bind:value="register.id"> {{register.name}}</option>
			</select>
			<select v-model.number="rd">
				<option v-for="register in r" v-bind:value="register.id" > {{register.name}}</option>
			</select>
		</div>
		<div v-if="selected == 'FLOAT'">
			<select v-model="op">
				<option v-for="operation in operationsFloat"> {{operation}}</option>
			</select>
			<select v-model.number="rt">
				<option v-for="register in f" v-bind:value="register.id"> {{register.name}}</option>
			</select>
			<select v-model.number="rs">
				<option v-for="register in f" v-bind:value="register.id"> {{register.name}}</option>
			</select>
			<select v-model.number="rd">
				<option v-for="register in f" v-bind:value="register.id"> {{register.name}}</option>
			</select>
		</div>
		

		<button v-on:click="insertInstruction">Inserir</button>


		<table>

			<tr v-for="inst in instructions">
				<th>{{inst.id}}</th>
				<th>{{inst.operation}}</th>
				<th v-if="inst.type == 'INTEGER'">{{r[inst.rt].name}}</th><th v-else>{{f[inst.rt].name}}</th>
				<th v-if="inst.type == 'INTEGER'">{{r[inst.rs].name}}</th><th v-else>{{f[inst.rt].name}}</th>
				<th v-if="inst.type == 'INTEGER'">{{r[inst.rd].name}}</th><th v-else>{{f[inst.rt].name}}</th>
			</tr>
			
		</table>
		<button v-on:click="executarNoFowarding">Executar</button>
	</div>
	

</body>
<script type="text/javascript">
	var app = new Vue({
		el: '#pipeline',
		data: {
			newTodoText: '',
			begin: 0,
			op: '',
			inteiro: -1, mult: -1, div: -1, add: -1,
			rt: -1, rs: -1, rd: -1,
			selected: 0,
			types: [
			'INTEGER',
			'FLOAT'
			],
			operationsInt: [
			'ADD',
			'SUB',
			'MULT',
			'DIV'
			],
			operationsFloat: [
			'ADD.D',
			'SUB.D',
			'MULT.D'],
			instructions: [
			{id:0, type: 'INTEGER',operation: 'ADD', rt: 0, rs: 1, rd: 3},
			{id:0, type: 'INTEGER',operation: 'ADD', rt: 1, rs: 0, rd: 3}
			],
			stalls: [],
			r: [
			{id: 0, name:"R0", readyAt: -1},
			{id: 1, name:"R1", readyAt: -1},
			{id: 2, name:"R2", readyAt: -1},
			{id: 3, name:"R3", readyAt: -1},
			{id: 4, name:"R4", readyAt: -1}
			],
			f: [
			{id: 0, name:"F0", readyAt: -1},
			{id: 2, name:"F2", readyAt: -1},
			{id: 4, name:"F4", readyAt: -1}
			],
			pipeline: []
		},
		methods: {
			addNewTodo: function () {
				this.todos.push(this.newTodoText)
				this.newTodoText = ''
			},
			insertInstruction: function() {
				this.instructions.push({id: this.instructions.length, 
					type: this.selected,
					operation:this.op, 
					rt: this.rt, 
					rs: this.rs, 
					rd: this.rd
				})
				//console.log(this.instructions)
			},
			executarNoFowarding: function() {
				console.log("entrou no metodo")
				var inst = this.instructions
				var pipe = this.pipeline
				var inicio = this.begin
				var registersInt = this.r
				var registersFloat = this.f
				var stall = this.stalls
				var f,d,ex,m,w = -1 
				for(i = 0; i < inst.length; i++) {
					console.log("entrou no for")
					console.log(inst[i].operation)
					switch(inst[i].operation) {
						case 'ADD':

						f = checkStall(inicio+1,stall)
						d = checkStall(f+1,stall)
							// IMPORTANTE - aqui no fowarding será diferente
							console.log(f,d)
							if (registersInt[inst[i].rs].readyAt <= d && registersInt[inst[i].rd].readyAt <= d ) {
								console.log("entrou no if")
								ex = d+1
								m = ex + 1
								w = m + 1
								registersInt[inst[i].rt].readyAt = w
								console.log(f,d,ex,m,w)
								//!!!!! PRECISA INSERIR NO VETOR PIPELINE !!!!!!! AINDA NAO ESTA FAZENDO ISSO
							} 
							//RAW - Read after write (registrador ainda nao tá pronto)
							if (registersInt[inst[i].rs].readyAt > d){
								//aqui tem que adicionar no vetor stall
								do {
									console.log("entrou no do")
									d= d+1
									insertStall(d,stall)
								} while (d < registersInt[inst[i].rs].readyAt)
								
							} if (registersInt[inst[i].rd].readyAt > d){
								//aqui tem que adicionar no vetor stall
								do {
									console.log("entrou no do")
									d= d+1
									insertStall(d,stall)
									
								} while (d < registersInt[inst[i].rd].readyAt)
							}

							console.log("vetor de bolha",stall)
							inicio = inicio + 1
							break;


							
						}
					}
				},
				executarFowarding: function() {

				}

			}

		})

	function checkStall (valor, vetor) {
		if(!vetor.includes(valor)) {
			return valor
		}
		return checkStall(valor+1,vetor)
	}

	function insertStall (valor, vetor) {
		if (!vetor.includes(valor)) {
			vetor = vetor.push(valor)
		}
	}
</script>
</html>